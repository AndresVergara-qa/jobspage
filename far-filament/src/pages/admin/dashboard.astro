---
import Layout from "../../layouts/Layout.astro"
import { categories } from "../../services/jobService"
---

<Layout title="Admin Dashboard | JobRadar">
  <div class="section-container py-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
      <div>
        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Admin Dashboard</h1>
        <p class="text-slate-500 text-sm mt-1">Manage job listings for JobRadar</p>
      </div>
      <button id="logout-btn" class="text-sm font-medium text-red-500 hover:text-red-600 flex items-center gap-1">
        <span class="material-icons text-sm">logout</span>
        Logout
      </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Add Job Form -->
      <div class="lg:col-span-2">
        <div class="card p-6 md:p-8">
          <h2 class="text-lg font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2">
            <span class="material-icons text-primary">add_circle</span>
            Add New Job
          </h2>

          <form id="add-job-form" class="space-y-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <div>
                <label class="block text-sm font-semibold mb-2" for="job-title">Job Title *</label>
                <input id="job-title" type="text" class="input-field" placeholder="e.g. Senior QA Engineer" required />
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" for="job-company">Company Name *</label>
                <input id="job-company" type="text" class="input-field" placeholder="e.g. TechCorp" required />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <div>
                <label class="block text-sm font-semibold mb-2" for="job-logo">Logo URL</label>
                <input id="job-logo" type="url" class="input-field" placeholder="https://example.com/logo.png" />
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" for="job-location">Location *</label>
                <input id="job-location" type="text" class="input-field" placeholder="e.g. Remote, New York" required />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
              <div>
                <label class="block text-sm font-semibold mb-2" for="job-category">Category *</label>
                <select id="job-category" class="input-field" required>
                  <option value="">Select category</option>
                  {categories.map((cat) => <option value={cat.name}>{cat.name}</option>)}
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" for="job-type">Job Type *</label>
                <select id="job-type" class="input-field" required>
                  <option value="Full-time">Full-time</option>
                  <option value="Part-time">Part-time</option>
                  <option value="Contract">Contract</option>
                  <option value="Freelance">Freelance</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" for="job-level">Level *</label>
                <select id="job-level" class="input-field" required>
                  <option value="Junior">Junior</option>
                  <option value="Mid">Mid</option>
                  <option value="Senior">Senior</option>
                  <option value="Lead">Lead</option>
                  <option value="Staff">Staff</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" for="job-salary">Salary Range</label>
              <input id="job-salary" type="text" class="input-field" placeholder="e.g. $100k – $140k" />
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" for="job-description">Description *</label>
              <textarea id="job-description" class="input-field min-h-[120px]" placeholder="Write a compelling job description..." required
              ></textarea>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" for="job-url">Application URL *</label>
              <input id="job-url" type="url" class="input-field" placeholder="https://company.com/careers/apply" required />
            </div>

            <!-- Success / Error messages -->
            <div id="form-success" class="hidden text-sm text-green-600 bg-green-50 dark:bg-green-900/20 p-3 rounded-lg flex items-center gap-2">
              <span class="material-icons text-sm">check_circle</span>
              Job added successfully!
            </div>
            <div id="form-error" class="hidden text-sm text-red-500 bg-red-50 dark:bg-red-900/20 p-3 rounded-lg flex items-center gap-2">
              <span class="material-icons text-sm">error</span>
              Something went wrong. Please try again.
            </div>

            <button type="submit" class="btn-primary w-full py-3 text-base">
              <span class="flex items-center justify-center gap-2">
                <span class="material-icons text-sm">publish</span>
                Publish Job
              </span>
            </button>
          </form>
        </div>
      </div>

      <!-- Saved Jobs List -->
      <div>
        <div class="card p-6">
          <h2 class="text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
            <span class="material-icons text-primary">list_alt</span>
            Admin Jobs
          </h2>
          <div id="admin-jobs-list" class="space-y-3">
            <!-- Populated by JS -->
          </div>
          <div id="no-admin-jobs" class="text-center py-8 text-slate-400">
            <span class="material-icons text-4xl mb-2">inbox</span>
            <p class="text-sm">No admin jobs yet.<br />Add one using the form.</p>
          </div>
        </div>

        <!-- Stats -->
        <div class="card p-6 mt-6">
          <h3 class="text-sm font-bold text-slate-900 dark:text-white uppercase tracking-wider mb-4">Quick Stats</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm text-slate-500">Admin Jobs</span>
              <span id="stat-admin-count" class="text-sm font-bold text-primary">0</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-slate-500">Mock Jobs</span>
              <span class="text-sm font-bold text-slate-700 dark:text-slate-300">8</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const AUTH_KEY = "jobradar_admin_auth"
  const STORAGE_KEY = "jobradar_admin_jobs"

  // ── Auth guard ──────────────────────────────────────────────────────────────
  if (sessionStorage.getItem(AUTH_KEY) !== "true") {
    window.location.href = "/admin"
  }

  // ── Logout ──────────────────────────────────────────────────────────────────
  document.getElementById("logout-btn")?.addEventListener("click", () => {
    sessionStorage.removeItem(AUTH_KEY)
    window.location.href = "/admin"
  })

  // ── Helpers ─────────────────────────────────────────────────────────────────
  interface AdminJob {
    id: string
    title: string
    company: string
    logoUrl: string
    location: string
    type: string
    level: string
    category: string
    salary: string
    description: string
    applicationUrl: string
    postedAt: string
    isVerified: boolean
    source: string
  }

  function getAdminJobs(): AdminJob[] {
    try {
      const raw = localStorage.getItem(STORAGE_KEY)
      return raw ? JSON.parse(raw) : []
    } catch {
      return []
    }
  }

  function saveAdminJobs(jobs: AdminJob[]) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(jobs))
  }

  // ── Render list ─────────────────────────────────────────────────────────────
  function renderAdminJobs() {
    const jobs = getAdminJobs()
    const list = document.getElementById("admin-jobs-list")!
    const empty = document.getElementById("no-admin-jobs")!
    const stat = document.getElementById("stat-admin-count")!

    stat.textContent = String(jobs.length)

    if (jobs.length === 0) {
      list.innerHTML = ""
      empty.classList.remove("hidden")
      return
    }

    empty.classList.add("hidden")
    list.innerHTML = jobs
      .map(
        (job) => `
        <div class="flex items-start justify-between gap-3 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
          <div class="min-w-0">
            <p class="text-sm font-semibold text-slate-900 dark:text-white truncate">${job.title}</p>
            <p class="text-xs text-slate-500 mt-0.5">${job.company} · ${job.location}</p>
          </div>
          <button
            class="delete-job-btn text-slate-400 hover:text-red-500 transition-colors shrink-0"
            data-id="${job.id}"
            title="Delete job"
          >
            <span class="material-icons text-sm">delete</span>
          </button>
        </div>
      `,
      )
      .join("")

    // Attach delete handlers
    document.querySelectorAll(".delete-job-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = (btn as HTMLElement).dataset.id!
        const updated = getAdminJobs().filter((j) => j.id !== id)
        saveAdminJobs(updated)
        renderAdminJobs()
      })
    })
  }

  // ── Form submission ─────────────────────────────────────────────────────────
  const form = document.getElementById("add-job-form") as HTMLFormElement
  const successEl = document.getElementById("form-success")!
  const errorEl = document.getElementById("form-error")!

  form?.addEventListener("submit", (e) => {
    e.preventDefault()

    try {
      const newJob: AdminJob = {
        id: `admin-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
        title: (document.getElementById("job-title") as HTMLInputElement).value,
        company: (document.getElementById("job-company") as HTMLInputElement).value,
        logoUrl: (document.getElementById("job-logo") as HTMLInputElement).value || "",
        location: (document.getElementById("job-location") as HTMLInputElement).value,
        type: (document.getElementById("job-type") as HTMLSelectElement).value,
        level: (document.getElementById("job-level") as HTMLSelectElement).value,
        category: (document.getElementById("job-category") as HTMLSelectElement).value,
        salary: (document.getElementById("job-salary") as HTMLInputElement).value || "",
        description: (document.getElementById("job-description") as HTMLTextAreaElement).value,
        applicationUrl: (document.getElementById("job-url") as HTMLInputElement).value,
        postedAt: new Date().toISOString(),
        isVerified: false,
        source: "admin",
      }

      const existing = getAdminJobs()
      existing.push(newJob)
      saveAdminJobs(existing)

      form.reset()
      renderAdminJobs()

      successEl.classList.remove("hidden")
      setTimeout(() => successEl.classList.add("hidden"), 3000)
    } catch {
      errorEl.classList.remove("hidden")
      setTimeout(() => errorEl.classList.add("hidden"), 3000)
    }
  })

  // ── Init ────────────────────────────────────────────────────────────────────
  renderAdminJobs()
</script>
